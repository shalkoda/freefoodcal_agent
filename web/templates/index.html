{% extends "base.html" %}

{% block content %}
<div class="stats-grid">
    <div class="stat-box">
        <div class="number">{{ stats.total_emails_processed }}</div>
        <div class="label">Emails Processed</div>
    </div>
    <div class="stat-box">
        <div class="number">{{ stats.total_events_found }}</div>
        <div class="label">Events Found</div>
    </div>
    <div class="stat-box">
        <div class="number">{{ stats.events_in_calendar }}</div>
        <div class="label">In Calendar</div>
    </div>
    <div class="stat-box">
        <div class="number">{{ stats.cohere_calls_today }}</div>
        <div class="label">Cohere Calls Today</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div class="card">
        <h2>Actions</h2>
        <div style="text-align: center; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 15px;">
            <button class="btn" onclick="triggerScan()">ğŸ” Scan Emails Now</button>
            <a href="/analytics" class="btn btn-secondary">ğŸ“Š View Analytics</a>
        </div>
        <div id="scan-status" style="margin-top: 15px;"></div>
    </div>
    <div class="card">
        <h2>Authentication</h2>
        <div style="text-align: center; display: flex; flex-direction: column; gap: 15px; justify-content: center; margin-top: 15px;">
            {% if google_authenticated %}
                <span style="color: #66a866; font-size: 0.9em; padding: 8px 16px; border: 1px solid #66a866; display: inline-block;">âœ… Google Calendar Connected</span>
            {% else %}
                <a href="/auth/google/login" class="btn" style="background: #fefefe; border: 2px solid #d4a5d9; color: #b896c6;">ğŸ” Connect Google Calendar</a>
            {% endif %}
            {% if microsoft_authenticated %}
                <span style="color: #66a866; font-size: 0.9em; padding: 8px 16px; border: 1px solid #66a866; display: inline-block;">âœ… Microsoft Outlook Connected</span>
            {% else %}
                <a href="/auth/microsoft/login" class="btn" style="background: #fefefe; border: 2px solid #d4a5d9; color: #b896c6;">ğŸ“§ Connect Microsoft Outlook</a>
            {% endif %}
        </div>
    </div>
</div>

<div class="card">
    <h2>Recent Events</h2>
    {% if recent_events %}
        <table>
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Location</th>
                    <th>Food Type</th>
                    <th>Confidence</th>
                </tr>
            </thead>
            <tbody>
                {% for event in recent_events %}
                <tr>
                    <td>{{ event.event_name }}</td>
                    <td>{{ event.event_date }}</td>
                    <td>{{ event.event_time }}</td>
                    <td>{{ event.location }}</td>
                    <td><span class="badge badge-info">{{ event.food_type }}</span></td>
                    <td><span class="badge badge-success">{{ (event.cohere_confidence * 100)|int }}%</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="font-size: 1em;">No events found yet. Click "Scan Emails Now" to start!</p>
    {% endif %}
</div>

<div class="card">
    <h2>Food Type Distribution</h2>
    {% if food_stats %}
        <table>
            <thead>
                <tr>
                    <th>Food Type</th>
                    <th>Count</th>
                    <th>Avg Confidence</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in food_stats %}
                <tr>
                    <td>{{ stat.food_type }}</td>
                    <td>{{ stat.count }}</td>
                    <td>{{ (stat.avg_confidence * 100)|int }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function triggerScan() {
    const statusDiv = document.getElementById('scan-status');
    statusDiv.innerHTML = '<p style="color: #8b6f9e; font-size: 1em; text-shadow: 0.5px 0.5px 0px #ffffff;">ğŸ”„ Scanning emails... This may take a minute.</p>';

    fetch('/scan', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const results = data.results;
                statusDiv.innerHTML = `
                    <div style="background: #fefefe; padding: 15px; border: 2px solid #d4a5d9; margin-top: 10px; box-shadow: 0 0 10px rgba(212, 165, 217, 0.3);">
                        <p style="color: #8b6f9e; font-weight: bold; margin-bottom: 10px; font-size: 1em; text-shadow: 0.5px 0.5px 0px #ffffff;">âœ… Scan complete!</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em; color: #8b6f9e; text-shadow: 0.5px 0.5px 0px #ffffff;">
                            <div><strong>Emails scanned:</strong> ${results.emails_scanned || 0}</div>
                            <div><strong>âœ… Passed Tier 1:</strong> ${results.passed_tier1_heuristic || 0}</div>
                            <div><strong>âœ… Passed Tier 2:</strong> ${results.passed_tier2_gemini || 0}</div>
                            <div><strong>ğŸ”µ Processed Tier 3:</strong> ${results.processed_tier3_cohere || 0}</div>
                            <div><strong>âŒ Filtered Tier 1:</strong> ${results.filtered_tier1 || 0}</div>
                            <div><strong>âŒ Filtered Tier 2:</strong> ${results.filtered_tier2 || 0}</div>
                            <div><strong>ğŸŸ¢ Gemini calls:</strong> ${results.gemini_calls || 0}</div>
                            <div><strong>ğŸ”µ Cohere calls:</strong> ${results.cohere_calls || 0}</div>
                            <div><strong>ğŸ• Events found:</strong> ${results.events_found || 0}</div>
                            <div><strong>ğŸ“… Events added:</strong> ${results.events_added || 0}</div>
                            ${results.skipped_budget ? `<div><strong>âš ï¸ Budget limit:</strong> ${results.skipped_budget}</div>` : ''}
                            ${results.errors && results.errors.length > 0 ? `<div><strong>âŒ Errors:</strong> ${results.errors.length}</div>` : ''}
                        </div>
                    </div>
                `;
                // Reload page after 3 seconds
                setTimeout(() => location.reload(), 3000);
            } else {
                statusDiv.innerHTML = `<p style="color: #ff8fab; font-size: 1em; text-shadow: 0.5px 0.5px 0px #ffffff;">âŒ Error: ${data.error}</p>`;
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `<p style="color: #ff8fab; font-size: 1em; text-shadow: 0.5px 0.5px 0px #ffffff;">âŒ Error: ${error}</p>`;
        });
}
</script>
{% endblock %}
